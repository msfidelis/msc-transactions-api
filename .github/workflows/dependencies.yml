name: Dependency Updates

on:
  schedule:
    # Executa toda segunda-feira √†s 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  update-dependencies:
    name: üì¶ Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'

      - name: Update Go modules
        run: |
          go get -u ./...
          go mod tidy

      - name: Run tests after update
        run: go test ./...

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Go dependencies"
          title: "üîÑ Update Go Dependencies"
          body: |
            ## üì¶ Dependency Updates
            
            This PR updates Go dependencies to their latest versions.
            
            ### Changes:
            - Updated Go modules to latest versions
            - Ran `go mod tidy` to clean up
            - Verified tests still pass
            
            ### Automated Checks:
            - [x] Tests pass
            - [x] Dependencies updated
            - [x] No conflicts detected
            
            ---
            *This PR was automatically created by the dependency update workflow.*
          branch: chore/update-dependencies
          delete-branch: true

  security-audit:
    name: üîç Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'

      - name: Run security audit
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Install gosec
        run: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: gosec ./...

      - name: Check for known vulnerabilities
        run: |
          go mod download
          go list -json -deps ./... | nancy sleuth